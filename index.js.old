const { createCanvas } = require("canvas");

const FormData = require("form-data");
const Discord = require("discord.js");
const Revolt = require("revolt.js");
const axios = require("axios");
const fs = require("fs");

const config = require("./config.json");

// Just get all discord intents because fuck discord
const discord_intents = Object.values(Discord.Intents.FLAGS);

// Create clients
const clients = {
    discord: {
        client: new Discord.Client({ intents: discord_intents }),
        message_event: "messageCreate",
        login: function() {
            this.client.login(config.tokens.discord);
        }
    },
    revolt: {
        client: new Revolt.Client(),
        message_event: "message",
        login: function() {
            this.client.loginBot(config.tokens.revolt);
        }
    }
}

// List of commands
const commands = [
    ["ch.help", "This command"],
    ["ch.ping", "Ping CH.AI"],
    ["ch.invite", "Invite CH.AI to a server"],
    ["ch.wallhaven", "Get a random wallpaper from wallhaven"],
    ["ch.wallhaven <tag>", "Search for wallpapers with a specific tag from wallhaven"],
    ["ch.colormind", "Get a random color pallette from colormind"]
]

// Log clients in
for (let client in clients) {
    clients[client].login();
}

// Keep track of how many clients are ready
let total_clients = Object.keys(clients).length;
let clients_ready = 0;

// ==================================================
// On clients ready
// ==================================================
for (let client in clients) {
    clients[client].client.on("ready", () => {
        clients_ready += 1;
        console.log(`CH.AI ${client} client online!`);
        if (clients_ready == total_clients) {
            ready_up();
        }
    });
}

// Fancy terminal output on startup
function ready_up() {
    console.log(`
                                ▒▒                                
                    ▒▒        ▒▒        ▒▒                        
                  ▒▒        ▒▒        ▒▒                          
                  ▒▒        ▒▒        ▒▒                          
                    ▒▒        ▒▒        ▒▒                        
                      ▒▒        ▒▒        ▒▒                      
                        ▒▒        ▒▒        ▒▒                    
                          ▒▒        ▒▒        ▒▒                  
                          ▒▒        ▒▒        ▒▒                  
                        ░░        ░░        ░░                    
                      ░░        ▒▒        ░░                      
                                                                  
                                                                  
                      ▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒                      
                ▓▓▓▓▓▓                      ▓▓▓▓▓▓                
              ▓▓        ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒        ▓▓              
            ██    ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒    ██            
            ▓▓██▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██▓▓            
            ▓▓  ▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓░░▓▓██████      
            ▓▓        ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓        ░░▓▓      ██    
            ▓▓                                    ░░▓▓██▒▒        
            ▓▓                                    ░░▓▓    ██    ▓▓
            ▓▓            CH.AI ONLINE            ░░▓▓    ▓▓    ▓▓
            ▓▓                                    ░░▓▓    ▓▓    ▓▓
            ▓▓                                    ░░▓▓▒▒▒▒▒▒░░░░░░
            ▓▓                                    ░░▓▓░░░░░░▒▒    
        ▒▒▒▒▓▓                                  ░░░░▓▓▓▓▓▓▓▓      
      ▒▒░░░░▓▓░░                                ░░░░▓▓░░░░░░▒▒    
    ▒▒░░      ▓▓░░                            ░░░░▓▓          ▒▒  
  ▓▓░░          ▓▓░░░░░░                  ░░░░░░▓▓            ░░▓▓
  ▓▓░░            ▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░▓▓▓▓              ░░▓▓
    ▓▓░░              ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                ░░▓▓  
      ▓▓░░░░░░                                        ░░░░░░▓▓    
        ▓▓▓▓██░░░░                            ░░░░░░░░▓▓▓▓▓▓      
              ▓▓▓▓██░░░░░░░░░░░░░░░░░░░░░░░░░░▓▓▓▓▓▓▓▓            
                    ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                    

=== BEGINNING LOG ===`);
}

// ==================================================
// On client message
// ==================================================
for (let client in clients) {
    clients[client].client.on(clients[client].message_event, (message) => {
        handleMessage(message, client);
    });
}

// ==================================================
// Handling messages
// ==================================================
async function handleMessage(message, client) {
    if ([Object.keys(clients).forEach((client) => { return clients[client].client.user.username })].includes(message.author.username)) { return false; }
    if (message.author.bot) { return false; }

    // ==================================================
    // Ping command
    // ==================================================
    if (message.content == "ch.ping") {
        message.reply("Pong!");
        return console.log(`${message.author.username} pinged CH.AI!`);
    }

    // ==================================================
    // Invite command
    // ==================================================
    if (message.content == "ch.invite") {
        let response;

        if (client == "discord") {
            response = `__**Discord Invite Link:**__ ${config.invites.discord}\n__**Revolt Invite Link:**__ ${config.invites.revolt}`;
        } else if (client == "revolt") {
            response = `[Revolt Invite](${config.invites.revolt})\n[D*scord Invite](${config.invites.discord})`;
        }

        message.reply(response);
        return console.log(`${message.author.username} got CH.AI invite links!`);
    }

    // ==================================================
    // Help command
    // ==================================================
    if (message.content == "ch.help") {
        let help_message;

        if (client == "discord") {
            let command_strings = [];
            commands.forEach(command => {
                command_strings.push(`${command[0]} ${".".repeat(30 - command[0].length)} ${command[1]}`);
            });
            help_message = command_strings.join("\n");
        } else if (client == "revolt") {
            let command_strings = [];
            commands.forEach(command => {
                command_strings.push(`| ${command[0]} | ${command[1]} |`);
            });
            help_message = `\`\`\`
# Basics
| Command | Function |
| ------- | -------- |
${command_strings.join("\n")}`;
        }

        message.reply(`\`\`\`
      ██    ██    ██                                    
    ██      ██  ██                                      
    ██    ██    ██                                      
      ██  ██      ██                                    
      ██    ██    ██                                    
                                                        
  ████████████████████                                  
  ██                ██████                              
  ██     CHAT       ██  ██                              
  ██  APPLICATION   ██  ██                              
  ██   INTERFACE    ██████                              
    ██            ██                                    
████████████████████████                                
██                    ██                                
  ████████████████████
${help_message}${(client == "discord") ? "\`\`\`" : "" }}`);
        return console.log(`${message.author.username} got CH.AI help!`);
    }

    // ==================================================
    // Wallhaven command
    // ==================================================
    if (message.content.startsWith("ch.wallhaven")) {
        if (message.content == "ch.wallhaven") {
            axios.get("https://wallhaven.cc/api/v1/search?sorting=random").then(response => {
                message.reply(response.data.data[0].url);
                return console.log(`${message.author.username} made a wallhaven request!`);
            });
        }
        else {
            let search = message.content.replace("ch.wallhaven ", "");
            axios.get(`https://wallhaven.cc/api/v1/search?q=${encodeURIComponent(search)}&sorting=random`).then(response => {
                message.reply(response.data.data[0].url);
                return console.log(`${message.author.username} did a wallhaven search!`);
            });
        }
    }

    // ==================================================
    // Colormind command
    // ==================================================
    // if (message.content.startsWith("ch.colormind")) {
    //     if (message.content == "ch.colormind") {
    //         axios.post("http://colormind.io/api/", { model: "default" }).then(response => {
    //             const colors = response.data.result;
    //             const canvas = createCanvas(50 * colors.length, 50);
    //             const context = canvas.getContext("2d");

    //             for (let i = 0; i < colors.length; i++) {
    //                 context.fillStyle = `rgb(${colors[i].join(", ")})`;
    //                 context.fillRect(50 * i, 0, 50 * (i + 1), 50);
    //             }

    //             const buffer = canvas.toBuffer("image/png");
    //             const attachment = new Discord.MessageAttachment(buffer, "colormind.png");

    //             if (client == "discord") {
    //                 message.reply({files: [attachment]});
    //                 return console.log(`${message.author.username} got a random colormind pallette!`);
    //             } else if (client == "revolt") {
    //                 fs.writeFileSync("./data/colormind.png", buffer);
    //                 let formData = new FormData();
    //                 formData.append("file", fs.createReadStream("./data/colormind.png"), "colormind.png");
    //                 axios.post(`https://api.anonfiles.com/upload`, formData, {
    //                     headers: {
    //                         ...formData.getHeaders()
    //                     }
    //                 }).then(response => {
    //                     message.reply(`hi ${response.data.data.file.url.full}`);
    //                     console.log(response.data.data.file.url.full);
    //                     return console.log(`${message.author.username} got a random colormind pallette!`);
    //                 });
    //             }
    //         });
    //     }
    // }
}